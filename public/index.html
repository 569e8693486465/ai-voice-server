<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HeyGen Avatar for Google Meet</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .video-container {
      grid-column: 1 / -1;
    }
    #avatarVideo {
      width: 100%;
      max-width: 800px;
      height: 450px;
      border: 3px solid #333;
      border-radius: 10px;
      background: #000;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: bold;
    }
    .status-connecting { background: #fff3cd; color: #856404; }
    .status-connected { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .btn-start { background: #28a745; color: white; }
    .btn-stop { background: #dc3545; color: white; }
    .btn-talk { background: #007bff; color: white; }
    .btn-repeat { background: #6f42c1; color: white; }
    button:hover { opacity: 0.9; }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 5px 0;
    }
    .log {
      height: 200px;
      overflow-y: auto;
      background: #1a1a1a;
      color: #00ff00;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ðŸ¤– HeyGen Avatar for Google Meet</h1>
  
  <div class="container">
    <div class="video-container panel">
      <div id="status" class="status status-connecting">
        ðŸ”„ Click "Start Avatar" to begin
      </div>
      <video id="avatarVideo" autoplay playsinline muted></video>
      <div class="controls">
        <button id="startBtn" class="btn-start" onclick="startAvatar()">Start Avatar</button>
        <button id="stopBtn" class="btn-stop" onclick="stopAvatar()" disabled>Stop Avatar</button>
        <input type="text" id="avatarIdInput" placeholder="Avatar ID (optional)" value="Wayne_20240711">
      </div>
    </div>

    <div class="panel">
      <h3>ðŸŽ¤ Manual Test (Without Recall.ai)</h3>
      <textarea id="textInput" placeholder="Enter text for avatar to speak..." rows="3"></textarea>
      <div class="controls">
        <button id="talkBtn" class="btn-talk" onclick="sendText('talk')" disabled>Talk (LLM)</button>
        <button id="repeatBtn" class="btn-repeat" onclick="sendText('repeat')" disabled>Repeat (Exact)</button>
      </div>
      
      <h3>ðŸ”— Recall.ai Integration</h3>
      <p>Webhook URL for Recall.ai:</p>
      <code id="webhookUrl"></code>
      <p><small>Configure this URL in your Recall.ai dashboard to receive meeting transcriptions</small></p>
    </div>

    <div class="panel" style="grid-column: 1 / -1;">
      <h3>ðŸ“‹ Connection Log</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // Global variables
    let ws;
    let room;
    let mediaStream;
    let currentSessionId;

    // DOM elements
    const statusDiv = document.getElementById("status");
    const avatarVideo = document.getElementById("avatarVideo");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const talkBtn = document.getElementById("talkBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const textInput = document.getElementById("textInput");
    const logDiv = document.getElementById("log");
    const webhookUrl = document.getElementById("webhookUrl");

    // Update webhook URL display
    webhookUrl.textContent = `${window.location.origin}/webhook/recall-transcription`;

    // Log function
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    // Connect to our WebSocket server
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log("âœ… Connected to avatar server");
        statusDiv.textContent = "âœ… Connected - Ready to start avatar";
        statusDiv.className = "status status-connected";
        startBtn.disabled = false;
      };

      ws.onmessage = async (event) => {
        try {
          const message = JSON.parse(event.data);
          log(`ðŸ“¨ Received: ${message.type}`);
          
          switch (message.type) {
            case "heygen_session_created":
              await connectToLiveKit(message.livekitUrl, message.livekitToken);
              currentSessionId = message.sessionId;
              break;
              
            case "heygen_session_stopped":
              resetUI();
              log("âœ… Avatar session stopped");
              break;
              
            case "text_sent_to_avatar":
              log(`âœ… Sent to avatar: "${message.text}" (${message.taskType})`);
              break;
              
            case "error":
              log(`âŒ Error: ${message.message}`);
              statusDiv.textContent = `âŒ Error: ${message.message}`;
              statusDiv.className = "status status-error";
              resetUI();
              break;
          }
          
        } catch (error) {
          log(`âŒ Error parsing message: ${error}`);
        }
      };

      ws.onclose = () => {
        log("ðŸ”´ Disconnected from server");
        statusDiv.textContent = "ðŸ”´ Disconnected from server";
        statusDiv.className = "status status-error";
        resetUI();
      };

      ws.onerror = (error) => {
        log(`âŒ WebSocket error: ${error}`);
        statusDiv.textContent = "âŒ Connection error";
        statusDiv.className = "status status-error";
      };
    }

    // Start the avatar
    async function startAvatar() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("Not connected to server");
        return;
      }

      const avatarId = document.getElementById("avatarIdInput").value.trim() || "Wayne_20240711";
      
      statusDiv.textContent = "ðŸ”„ Starting HeyGen avatar...";
      startBtn.disabled = true;
      
      log(`ðŸš€ Starting avatar: ${avatarId}`);
      
      ws.send(JSON.stringify({
        type: "start_avatar",
        avatarId: avatarId
      }));
    }

    // Connect to LiveKit room
    async function connectToLiveKit(livekitUrl, livekitToken) {
      try {
        log("ðŸ”— Connecting to LiveKit...");
        
        // Create LiveKit room
        room = new LivekitClient.Room({
          adaptiveStream: true,
          dynacast: true
        });

        // Create media stream for video
        mediaStream = new MediaStream();

        // Handle incoming tracks
        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
          log(`ðŸŽ¥ Track subscribed: ${track.kind} from ${participant.identity}`);
          
          if (track.kind === "video" || track.kind === "audio") {
            mediaStream.addTrack(track.mediaStreamTrack);
            
            // When we have both video and audio, set up the video element
            if (mediaStream.getVideoTracks().length > 0) {
              avatarVideo.srcObject = mediaStream;
              log("âœ… Avatar video stream connected");
              
              statusDiv.textContent = "âœ… Avatar Live - Speak in your meeting!";
              stopBtn.disabled = false;
              talkBtn.disabled = false;
              repeatBtn.disabled = false;
            }
          }
        });

        // Handle disconnections
        room.on(LivekitClient.RoomEvent.Disconnected, () => {
          log("ðŸ”´ Disconnected from LiveKit");
          resetUI();
        });

        // Connect to the room
        await room.connect(livekitUrl, livekitToken);
        log("âœ… Connected to LiveKit room");

      } catch (error) {
        log(`âŒ LiveKit connection failed: ${error}`);
        statusDiv.textContent = "âŒ Failed to connect to avatar video";
        statusDiv.className = "status status-error";
        resetUI();
      }
    }

    // Stop the avatar
    function stopAvatar() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        log("ðŸ›‘ Stopping avatar...");
        ws.send(JSON.stringify({ type: "stop_avatar" }));
      }
      
      if (room) {
        room.disconnect();
        room = null;
      }
      
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      
      if (avatarVideo.srcObject) {
        avatarVideo.srcObject = null;
      }
      
      resetUI();
    }

    // Send text to avatar
    function sendText(taskType) {
      const text = textInput.value.trim();
      if (!text) {
        alert("Please enter some text");
        return;
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("Not connected to server");
        return;
      }

      log(`ðŸ“¤ Sending text (${taskType}): ${text}`);
      
      ws.send(JSON.stringify({
        type: "user_speech",
        text: text,
        taskType: taskType
      }));
      
      textInput.value = "";
    }

    // Reset UI state
    function resetUI() {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      talkBtn.disabled = true;
      repeatBtn.disabled = true;
      statusDiv.textContent = "ðŸ”„ Ready to start avatar";
      statusDiv.className = "status status-connecting";
    }

    // Initialize when page loads
    window.addEventListener('load', () => {
      log("ðŸ”Œ Initializing...");
      connectWebSocket();
    });

    // Handle Enter key in text input
    textInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendText('talk');
      }
    });
  </script>
</body>
</html>
