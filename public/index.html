<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Realtime AI Voice</title>
    <style>
      body { font-family: sans-serif; background: #111; color: #fff; text-align: center; padding: 50px; }
      button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; background: #0a84ff; color: #fff; }
      button:hover { background: #0066cc; }
    </style>
  </head>
  <body>
    <h1>ðŸŽ¤ Real-time AI Voice</h1>
    <button id="startBtn">Start Conversation</button>
    <p id="status">Idle</p>

    <script>
      const statusEl = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();

      let ws;

      startBtn.onclick = async () => {
        statusEl.textContent = "Connecting...";

        // Get OpenAI Realtime session token
        const tokenResponse = await fetch("https://avatar-server-yp11.onrender.com/session");
        const data = await tokenResponse.json();

        // Connect to our WebSocket proxy
        ws = new WebSocket("wss://avatar-server-yp11.onrender.com");
        ws.onopen = () => {
          statusEl.textContent = "Connected. Speaking...";
          ws.send(JSON.stringify({
            type: "response.create",
            response: {
              instructions: "Hello there! Iâ€™m your AI assistant speaking in real time. How are you today?",
            }
          }));
        };

        // For streaming playback
        let nextStartTime = audioContext.currentTime;

        ws.onmessage = async (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === "audio-chunk") {
            const audioBuffer = base64ToAudioBuffer(msg.data);
            playAudioBuffer(audioBuffer);
          } else if (msg.type === "done") {
            statusEl.textContent = "Done speaking!";
          }
        };

        function base64ToAudioBuffer(base64) {
          const binary = atob(base64);
          const len = binary.length;
          const buffer = new ArrayBuffer(len);
          const view = new Uint8Array(buffer);
          for (let i = 0; i < len; i++) view[i] = binary.charCodeAt(i);
          return audioContext.decodeAudioData(buffer);
        }

        async function playAudioBuffer(promiseBuffer) {
          const buffer = await promiseBuffer;
          const source = audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(audioContext.destination);
          const now = audioContext.currentTime;
          const startAt = Math.max(now, nextStartTime);
          source.start(startAt);
          nextStartTime = startAt + buffer.duration;
        }
      };
    </script>
  </body>
</html>
