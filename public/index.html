<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Realtime Voice Bot</title>
  </head>
  <body>
    <h2>ğŸ¤– Realtime Bot is running...</h2>
    <p id="status">Connecting to meeting audio...</p>

    <script>
      async function start() {
        const status = document.getElementById("status");

        // ğŸ™ï¸ ××§×‘×œ ××ª ×”××•×“×™×• ××”×¤×’×™×©×” (Recall.ai ×›×‘×¨ × ×•×ª×Ÿ ×”×¨×©××”)
        const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const meetingAudioTrack = mediaStream.getAudioTracks()[0];

        const trackProcessor = new MediaStreamTrackProcessor({ track: meetingAudioTrack });
        const reader = trackProcessor.readable.getReader();

        // ğŸ§ ×× ×’×Ÿ ××ª ×”×§×•×œ ×©×œ ×”-AI ×—×–×¨×” ×‘×¤×’×™×©×”
        const audioOut = new Audio();
        const audioContext = new AudioContext();
        const audioStream = audioContext.createMediaStreamDestination();
        audioOut.srcObject = audioStream.stream;

        // ğŸ§© ××—×‘×¨ ××œ ×”×©×¨×ª ×©×œ×š (WebSocket)
        const ws = new WebSocket("wss://https://avatar-server-yp11.onrender.com/");

        ws.onopen = () => {
          console.log("Connected to server âœ…");
          status.textContent = "Connected to Realtime API";
        };

        ws.onmessage = async (event) => {
          const msg = JSON.parse(event.data);

          // ×× OpenAI ××—×–×™×¨ ××•×“×™×•
          if (msg.type === "output_audio_buffer.delta" && msg.delta) {
            const audioBytes = Uint8Array.from(atob(msg.delta), (c) => c.charCodeAt(0));
            const audioBuffer = await audioContext.decodeAudioData(audioBytes.buffer);
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
          }
        };

        ws.onclose = () => {
          console.log("Disconnected âŒ");
          status.textContent = "Disconnected from server.";
        };

        // ğŸ¤ ×©×•×œ×— ×›×œ ××§×˜×¢ ×§×•×œ ××œ ×”×©×¨×ª ×©×œ×š (×©×™×¢×‘×™×¨ ×œ××•×¤×Ÿ ××™×™ ××™×™)
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            ws.send(
              JSON.stringify({
                type: "input_audio_buffer.append",
                audio: arrayBufferToBase64(value.data.buffer),
              })
            );
          }
        }
      }

      // ×××™×¨ ××•×“×™×• ×œ-base64 ×›×“×™ ×œ×©×œ×•×— ×‘-WebSocket
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
      }

      start().catch((err) => {
        console.error("Error starting bot:", err);
        document.getElementById("status").textContent = "Error: " + err.message;
      });
    </script>
  </body>
</html>
