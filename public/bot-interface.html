<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tavus Bot Interface</title>
  <style>
    body { margin: 0; padding: 0; background: #000; color: white; font-family: Arial; }
    #container { display: flex; flex-direction: column; height: 100vh; }
    #status { padding: 10px; background: #333; text-align: center; }
    #tavusFrame { flex: 1; border: none; }
    #logs { padding: 10px; background: #1a1a1a; color: #00ff00; font-family: monospace; height: 100px; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="container">
    <div id="status">ðŸ”„ Loading Tavus Avatar...</div>
    <iframe id="tavusFrame" allow="camera; microphone; autoplay"></iframe>
    <div id="logs"></div>
  </div>

  <script>
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const conversationUrl = urlParams.get('conversationUrl');
    const conversationId = urlParams.get('conversationId');
    
    const status = document.getElementById('status');
    const tavusFrame = document.getElementById('tavusFrame');
    const logs = document.getElementById('logs');

    let dailyCall;

    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logs.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      logs.scrollTop = logs.scrollHeight;
      console.log(message);
    }

    // Initialize Daily.co call frame
    async function initializeDailyCall() {
      if (!conversationUrl) {
        status.textContent = 'âŒ Missing conversation URL';
        return;
      }

      try {
        // Load Daily.co library
        await loadDailyLibrary();
        
        // Create Daily call frame
        dailyCall = window.DailyIframe.createFrame(tavusFrame, {
          url: conversationUrl,
          iframeStyle: {
            position: 'absolute',
            width: '100%',
            height: '100%',
            border: '0'
          }
        });

        // Set up event listeners
        dailyCall.on('loaded', () => {
          status.textContent = 'âœ… Tavus Avatar Loaded';
          log('Daily.co frame loaded');
        });

        dailyCall.on('joining-meeting', () => {
          log('ðŸ”„ Joining Tavus conversation...');
        });

        dailyCall.on('joined-meeting', (event) => {
          status.textContent = 'âœ… Joined Tavus Conversation';
          log('Successfully joined Tavus conversation');
          log(`Conversation ID: ${conversationId}`);
        });

        dailyCall.on('app-message', (event) => {
          log(`Received app message: ${JSON.stringify(event.data)}`);
        });

        dailyCall.on('error', (error) => {
          status.textContent = 'âŒ Daily.co Error';
          log(`Error: ${error}`);
        });

        dailyCall.on('load-attempt-failed', (e) => {
          log(`âŒ Daily.co load failed: ${e.errorMsg}`);
        });

        dailyCall.on('nonfatal-error', (e) => {
          log(`âš ï¸ Daily.co nonfatal error: ${e.errorMsg}`);
        });

        // Join the call with bot-optimized settings
        await dailyCall.join({
          video: false,
          audio: false,
          startWithAudioMuted: true,
          startWithVideoMuted: true
        });
        
      } catch (error) {
        status.textContent = 'âŒ Failed to initialize Daily.co';
        log(`Initialization error: ${error.message}`);
      }
    }

    // Load Daily.co library
    function loadDailyLibrary() {
      return new Promise((resolve, reject) => {
        if (window.DailyIframe) {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@daily-co/daily-js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // Function to send text to Tavus avatar
    function sendTextToAvatar(text) {
      if (!dailyCall) {
        log('âŒ Daily call not initialized');
        return;
      }

      const message = {
        "message_type": "conversation",
        "event_type": "conversation.respond", 
        "conversation_id": conversationId,
        "properties": {
          "text": text
        }
      };

      dailyCall.sendAppMessage(message, '*')
        .then(() => {
          log(`âœ… Sent to avatar: "${text}"`);
        })
        .catch(error => {
          log(`âŒ Failed to send message: ${error}`);
        });
    }

    // WebSocket connection to receive transcriptions from server
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}/transcriptions?conversationId=${conversationId}`);
      
      ws.onopen = () => {
        log('âœ… Connected to transcription server');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.text && data.type === 'transcription') {
            log(`ðŸŽ¤ Received transcription: "${data.text}"`);
            sendTextToAvatar(data.text);
          }
        } catch (error) {
          log(`âŒ Error parsing WebSocket message: ${error}`);
        }
      };

      ws.onclose = () => {
        log('ðŸ”´ Disconnected from transcription server');
        // Attempt to reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
      };

      ws.onerror = (error) => {
        log(`âŒ WebSocket error: ${error}`);
      };
    }

    // Initialize everything when page loads
    window.addEventListener('load', () => {
      log('Bot interface initialized');
      log(`Conversation ID: ${conversationId}`);
      initializeDailyCall();
      
      // Wait a bit before connecting WebSocket to ensure Daily.co is loaded
      setTimeout(connectWebSocket, 2000);
    });

    // For testing: simulate receiving a transcription
    window.testSendText = function(text) {
      sendTextToAvatar(text || "Hello, this is a test message from the meeting!");
    };

  </script>
</body>
</html>
